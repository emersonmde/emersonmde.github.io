{"componentChunkName":"component---src-templates-blog-post-js","path":"/1-billion-row-challenge-part-1/","result":{"data":{"site":{"siteMetadata":{"title":"Error Signal"}},"markdownRemark":{"id":"2871f3ca-913e-55df-b40f-36c8b90aba64","excerpt":"The 1 Billion Row Challenge is a\ncompetition to read and process a billion rows from a text file in Java. The\nREADME for the\nchallenge states: The One Billionâ€¦","html":"<p>The <a href=\"https://github.com/gunnarmorling/1brc\">1 Billion Row Challenge</a> is a\ncompetition to read and process a billion rows from a text file in Java. The\n<a href=\"https://github.com/gunnarmorling/1brc/blob/main/README.md\">README</a> for the\nchallenge states:</p>\n<blockquote>\n<p>The One Billion Row Challenge (1BRC) is a fun exploration of how far modern\nJava can be pushed for aggregating one billion rows from a text file. Grab\nall your (virtual) threads, reach out to SIMD, optimize your GC, or pull any\nother trick, and create the fastest implementation for solving this task!</p>\n<p>The text file contains temperature values for a range of weather stations.\nEach row is one measurement in the format\n<code class=\"language-text\">&lt;string: station name>;&lt;double: measurement></code>, with the measurement value\nhaving exactly one fractional digit.</p>\n<div class=\"gatsby-highlight\" data-language=\"csv\"><pre class=\"language-csv\"><code class=\"language-csv\"><span class=\"token value\">Hamburg;12.0</span>\n<span class=\"token value\">Bulawayo;8.9</span>\n<span class=\"token value\">Palembang;38.8</span></code></pre></div>\n<p>The task is to write a Java program which reads the file, calculates the min,\nmean, and max temperature value per weather station, and emits the results on\nstdout</p>\n</blockquote>\n<p>My mind started racing with ideas picturing all sorts of arcane low level APIs,\ncompiler tricks, and JVM internals I could use. Most of which I barely knew the\nname of let alone how to use them. I was excited to dive in and learn as much\nas I could about what pushing the limits of Java would look like in practice.</p>\n<h2>The Rules</h2>\n<p>The rules of the challenge are simple:</p>\n<ul>\n<li>All calculations have to be done at runtime</li>\n<li>Implementations must not rely on specifics of a given data set</li>\n<li>Implementations must be provided as a single source file</li>\n<li>No external library dependencies may be used</li>\n</ul>\n<p>The <a href=\"https://github.com/gunnarmorling/1brc/blob/main/README.md\">README</a>\ndescribes how to create the dataset which resulted in a ~13GB file. With my\nmeasurements generated, I was ready to dive in.</p>\n<h2>My Plan</h2>\n<p>From my brief exploration in C, I knew memory mapping a file was a fast way to\nread large files, leaning on the operating system to manage\nloading the file into memory. This would be particularly useful with such a\nlarge file that could consume all available memory. The operating\nsystem would ensure the correct pages are loaded into memory when needed and\nevict them after they are no longer used.</p>\n<p>Finally, I remember reading about Java's ConcurrentHashMap after being\nfrustrated with lock contention in Rust when trying to share a\n<code class=\"language-text\">Arc&lt;Mutex&lt;HashMap>></code> between threads. The implementation of Java's\nConcurrentHashMap was touted as a clever design to reduce lock contention and\nprovide a high level of concurrency.</p>\n<p>My overall approach was:</p>\n<ul>\n<li>Memory map the file</li>\n<li>Create a thread pool</li>\n<li>Have each thread read a chunk of the memory mapped file</li>\n<li>Parse the chunk into weather stations and temperature values</li>\n<li>Update the ConcurrentHashMap with the min, mean, and max temperature values</li>\n</ul>\n<h1>First Attempt</h1>\n<p>I was pretty familiar with Java's <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html\">ExecutorService</a>\nand <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/Collections.html\">Collections API</a>\nbut I didn't know if it was even possible to memory map a file in Java.\nThankfully, after a quick consultation with ChatGPT, I come to find Java\nprovides <a href=\"https://docs.oracle.com/javase/8/docs/api/java/io/RandomAccessFile.html\">RandomAccessFile</a>\nand <a href=\"https://docs.oracle.com/javase/8/docs/api/java/nio/channels/FileChannel.html\">FileChannel</a>\nwhich can be used to memory map a file. Just what I was looking for!</p>\n<h2>Putting It All Together</h2>\n<p>First up, memory mapping the file and setting up the HashMap:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RandomAccessFile</span> file <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RandomAccessFile</span><span class=\"token punctuation\">(</span><span class=\"token constant\">FILE</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">FileChannel</span> fileChannel <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">getChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">long</span> fileSize <span class=\"token operator\">=</span> fileChannel<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeasurementAggregator</span><span class=\"token punctuation\">></span></span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> processors <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">availableProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">ExecutorService</span> executor <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span>processors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Setting up the container to hold the measurements:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MeasurementAggregator</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">double</span> min <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POSITIVE_INFINITY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">double</span> max <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEGATIVE_INFINITY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">double</span> sum<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> count<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        min <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        max <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        sum <span class=\"token operator\">+=</span> value<span class=\"token punctuation\">;</span>\n        count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then chunk the file and send it to the thread pool for processing:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">long</span> position <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>position <span class=\"token operator\">&lt;</span> fileSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> chunkSize <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CHUNK_SIZE</span><span class=\"token punctuation\">,</span> fileSize <span class=\"token operator\">-</span> position<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">MappedByteBuffer</span> buffer <span class=\"token operator\">=</span> fileChannel<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FileChannel<span class=\"token punctuation\">.</span>MapMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">READ_ONLY</span><span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> chunkSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> future <span class=\"token operator\">=</span> executor<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">processChunk</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    futures<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    position <span class=\"token operator\">+=</span> chunkSize<span class=\"token punctuation\">;</span>\n    position <span class=\"token operator\">=</span> <span class=\"token function\">adjustToLineEnd</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> fileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally, I process the chunk and update the ConcurrentHashMap:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processChunk</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MappedByteBuffer</span> buffer<span class=\"token punctuation\">,</span> \n        <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeasurementAggregator</span><span class=\"token punctuation\">></span></span> results<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">StringBuilder</span> line <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">hasRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">char</span> c <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token char\">'\\n'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">processLine</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            line<span class=\"token punctuation\">.</span><span class=\"token function\">setLength</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            line<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">processLine</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processLine</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> line<span class=\"token punctuation\">,</span> \n        <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeasurementAggregator</span><span class=\"token punctuation\">></span></span> results<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> parts <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parts<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> station <span class=\"token operator\">=</span> parts<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">double</span> value <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseDouble</span><span class=\"token punctuation\">(</span>parts<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        results<span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>\n                station<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n                        v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MeasurementAggregator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    v<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">return</span> v<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>JVM Settings</h2>\n<p>At my day job, I've built many Java services both large and small. I was\nfamiliar with the process of tuning the JVM and garbage collection but have\nrarely needed to do so. I went down the rabbit hole of JVM tuning and\nperformance optimization when I learned about <a href=\"https://www.graalvm.org/\">GraalVM</a>\nand it's <a href=\"https://www.graalvm.org/latest/reference-manual/native-image/\">native binary feature</a>\nthat would compile Java to native machine code. I was excited to see if this\nwould provide an advantage over the standard JVM.</p>\n<p>In addition to using a native GraalVM binary, I also wanted the JVM to use\nall available system resources regardless of the hardware it was running on.\nThis is no easy task as you have to specify at runtime the maximum heap size.\nOff to ChatGPT to write a script to calculate the required settings and\nlaunch the program.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function-name function\">get_system_info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token environment constant\">$OSTYPE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"linux-gnu\"</span>* <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token assign-left variable\">total_memory</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">free</span> <span class=\"token parameter variable\">-m</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'/^Mem:/ {print $2}'</span><span class=\"token variable\">)</span></span>\n    <span class=\"token assign-left variable\">num_cores</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span>\n  <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token environment constant\">$OSTYPE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"darwin\"</span>* <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token assign-left variable\">total_memory</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-n</span> hw.memsize <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print int($1/1024/1024)}'</span><span class=\"token variable\">)</span></span>\n    <span class=\"token assign-left variable\">num_cores</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-n</span> hw.ncpu<span class=\"token variable\">)</span></span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Unsupported OS type: <span class=\"token environment constant\">$OSTYPE</span>\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Function to determine optimal heap size and GC type</span>\n<span class=\"token function-name function\">determine_optimal_settings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># Set heap size to 90% of system memory and convert to integer</span>\n  <span class=\"token assign-left variable\">MAX_HEAP_SIZE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"scale=0; (<span class=\"token variable\">$total_memory</span> * .9) / 1\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">bc</span><span class=\"token variable\">)</span></span>M\n  <span class=\"token comment\"># Set min heap size to same as max heap size</span>\n  <span class=\"token assign-left variable\">MIN_HEAP_SIZE</span><span class=\"token operator\">=</span><span class=\"token variable\">$MAX_HEAP_SIZE</span>\n\n  <span class=\"token assign-left variable\">GC_TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"--gc=G1\"</span>\n\n  <span class=\"token comment\"># Output the determined settings</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Optimal Settings:\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Max Heap Size: <span class=\"token variable\">$MAX_HEAP_SIZE</span>\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Min Heap Size: <span class=\"token variable\">$MIN_HEAP_SIZE</span>\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Garbage Collector Type: <span class=\"token variable\">$GC_TYPE</span>\"</span>\n\n  <span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"--enable-preview -Xms<span class=\"token variable\">$MIN_HEAP_SIZE</span> -Xmx<span class=\"token variable\">$MAX_HEAP_SIZE</span> <span class=\"token variable\">$GC_TYPE</span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Check if the native image exists</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-f</span> ./image_calculateaverage_emersonmde <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Running native image with optimal hardware settings...\"</span>\n\n  <span class=\"token comment\"># Get system info</span>\n  get_system_info\n\n  <span class=\"token comment\"># Determine optimal settings for native image</span>\n  determine_optimal_settings\n\n  <span class=\"token comment\"># Run the native image with determined settings</span>\n  <span class=\"token function\">time</span> ./image_calculateaverage_emersonmde <span class=\"token variable\">$JAVA_OPTS</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token comment\"># Get system info</span>\n  get_system_info\n\n  determine_optimal_settings\n\n  <span class=\"token comment\"># Output hardware and JVM settings</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"System Hardware Details:\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Number of CPU Cores: <span class=\"token variable\">$num_cores</span>\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Total System Memory: <span class=\"token variable\">$total_memory</span> MB\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Calculating averages using emersonmde with JVM options: '<span class=\"token variable\">$JAVA_OPTS</span>'\"</span>\n\n  <span class=\"token comment\"># Run the application in JVM mode</span>\n  <span class=\"token function\">time</span> <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_emersonmde\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>I also looked into the different garbage collector implementations and took\nnote of the <a href=\"https://docs.oracle.com/en/java/javase/17/gctuning/garbage-first-g1-garbage-collector1.html#GUID-ED3AB6D3-FD9B-4447-9EDF-983ED2F7A573\">G1 garbage collector</a>.\nIt was designed to provide a high throughput and low latency by using multiple\nthreads to perform the garbage collection concurrently with the application\nthreads. Thankfully this is already set as the default in newer versions of\nGraalVM.</p>\n<h2>The Results</h2>\n<p>I eagerly ran the program and waited for the results. The first run finished\nin just 79 seconds. I thought for sure this was blazing fast and went to the\nleaderboard to see how my solution stacked up to the competition. Turns out,\nwhile this was much faster than the slowest entry at over 4 minutes, it was\nnear the end at 44th out of 55 entries. The first place entry was reported\nat a mere 6 seconds. Granted this was likely benchmarked on much better\nhardware that wasn't running IntelliJ, I knew I had to step up my game to even\nbe in the same league.</p>\n<h1>Attempt #2</h1>\n<p>I was well aware of the vast performance difference between some of the Java\nAPIs despite them doing the same thing. I thought maybe it would be faster\nto sequentially parse each line instead of using <code class=\"language-text\">String.split</code>. I also\nassumed having each thread process a local region of the file instead of\npassing in the entire buffer would be faster.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Optional</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MappedByteBuffer</span> buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> content <span class=\"token operator\">=</span> <span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> lines <span class=\"token operator\">=</span> content<span class=\"token punctuation\">.</span><span class=\"token function\">lines</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> lines<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>line <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">int</span> separatorIndex <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\";\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>separatorIndex <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n\n                    <span class=\"token class-name\">String</span> station <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> separatorIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">String</span> valueString <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span>separatorIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>valueString<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> valueString<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">double</span> value <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseDouble</span><span class=\"token punctuation\">(</span>valueString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AbstractMap<span class=\"token punctuation\">.</span>SimpleImmutableEntry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>station<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NumberFormatException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Optional</span><span class=\"token operator\">::</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With these changes I reran the program a few more times and didn't see any\nadditional gains. Clearly the bottleneck was not with the reading of the\ndata or splitting the lines. It would have been easy to run this through a\nprofiler and see exactly what the problem was but who wants to spoil the\nending of this journey? It was time to dig deeper!</p>\n<h2>A wild SIMD appears</h2>\n<p>SIMD, single instruction multiple data, is a feature of most modern CPUs that\nexecutes the same operation on multiple data points in parallel (Figure 1).\nUtilizing Java's <a href=\"https://docs.oracle.com/en/java/javase/17/docs/api/jdk.incubator.vector/jdk/incubator/vector/Vector.html\">Vector API</a>,\na platform independent API that compiles to native SIMD instructions on\nsupported architectures. I expected to see a significant speed increase\nby preforming the addition, min, and max in parallel.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 440px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/502682e2edf8d0c2ec3ae1148e46351a/48c0e/SIMD2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEJ0lEQVR42m1UCVNaVxTmT3amyyRTbdJmUhtldQG3mTQ1aRXTTk1sVIKKwiOgD+GxPfZN9geyPHisDTwoIAhGdqEX08wYp9/cOfPm3fnu+c45372U4W0MBmky70vE/SkCSyf8ybgvEfOn4liKANFL4OAPlhzteqLhaq1GyefzBEF4PJ5MOt34cGmKnenjIW0EU2AuEE3JqDLoQQJubSRgTuE6PIhGME3YryfCCKql4DiuUqkgCLLb7ZVq1ZEl1AHPNix5sfWaj8A8+fEWLP1TdPj6HSSxGl9Bwg3ocEd25CuTe2IR5ZPeAYjNZlPrPlVibhXmBkeoMI8u7DbibkN0FNUBKxpy6CMuU9wrNiJSGKYAWv+63+v3BoNrwM+TpMFk0up1qF6PGlDu7xIW+93svHCaI+IsHy0sQzPs3fllycqLw2KBpJC5csiXDvuzmWT+VuNGQtLpOmvuSrRxFlO6nGLHMifNnB1O0coz7MEU/eIYPqXEQ3nc/08qUtXI7clkEtBa7Xaz1R4O+2ZL9tEP1vd6mZHHrVigvTXRt9/jzGmSvfiByqivcY8piWiBCFWy8bpabvN6vZ1O52KEerd7ZTAmHjzQkkbV2ZGgYJDyfxN8MxagM0kgZ4peX38JU5J4EXNmolgBZI7FcKD2eoSRbJ+/NEm/gN9oun4doYCmaYZpTp/GzL/abE/PNda4MCVLVHRKj/hApVO6ItEI4PRG6IMPt6c4Rct5pNqiUVazIi9/Nk8yLunMPI/fnuXckDNExao7E+0rUKXT7Xa1Wq1qtQZWp32J6vD796CMQSblrqTUQt4q74uvLTQGufmmNTffWFsD5HjZbohA+0oUcQLD3Jbt8ZYmqWkcQZtufdkM//FUPkG/oLMKz1aadFaDuw5T0vGSyxJTHFlQ5PQOeVQz41K8oe1j+phczKQ55haup+i5nbed/zJnE+dqmWN3W6pTuYLBwEefNZstULvV9vfjx84sitj2Nmu2E/4qPP4oyWCRb3fbs+yPDUtUtArX4a5cp3R6fd5ut1sfodHvNcGoxsfkeRNyKtjKoWL+6u5X9z2gZv5eh7PYWB3VTJTlErPi2KJFTv9vVFUNXzMMmrIaKYepY7F7YFSCgw574YY8MskZMElDfWK7Q/b6SlRGxXKI1h3KvB5+vmRnzLTpzNzTZy0as74OGpaMFnGsmIycg1H5/b7PZRPjY7KsXg6t/pJWi/jc/S/vuVgzwNufHIaH3seDFTLVOuDD4XAYJGy3260bb9vsuYmfQgUL2g3qe5hy+1fJj9TS4lJnYbnDmu1w12WU83JNjZiEAlh4AIG7+dmtypSpzNQSC+U9P1hf4D98aH5CLU1MZp5QybHvfDs86egxaLWbV1eXoNDhXQwwLLwn0Py1c7LNR0QQKhIpwRIKlTCM1GqVfwHBMtCEAK5u0wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SIMD processing pipeline\"\n        title=\"Figure 1. SIMD Processing \nPipeline By Vadikus - Own work, CC BY-SA 4.0\"\n        src=\"/static/502682e2edf8d0c2ec3ae1148e46351a/48c0e/SIMD2.png\"\n        srcset=\"/static/502682e2edf8d0c2ec3ae1148e46351a/c26ae/SIMD2.png 158w,\n/static/502682e2edf8d0c2ec3ae1148e46351a/6bdcf/SIMD2.png 315w,\n/static/502682e2edf8d0c2ec3ae1148e46351a/48c0e/SIMD2.png 440w\"\n        sizes=\"(max-width: 440px) 100vw, 440px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Figure 1. SIMD Processing \nPipeline By Vadikus - Own work, CC BY-SA 4.0</figcaption>\n  </figure></p>\n<p>In order to use the Vector API, the data must be copied into a vector by\nusing the <a href=\"https://docs.oracle.com/en/java/javase/17/docs/api/jdk.incubator.vector/jdk/incubator/vector/DoubleVector.html#fromArray(jdk.incubator.vector.VectorSpecies,double%5B%5D,int)\"><code class=\"language-text\">DoubleVector.fromArray()</code></a>\nmethod. Once the vector is created <a href=\"https://docs.oracle.com/en/java/javase/17/docs/api/jdk.incubator.vector/jdk/incubator/vector/DoubleVector.html#reduceLanes(jdk.incubator.vector.VectorOperators.Associative)\"><code class=\"language-text\">DoubleVector.reduceLanes()</code></a>\ncan be used with an operation and optional mask that will reduce the vector\nto a single value using the operation and data supplied. The species also\nneeds to be specified which tells the Vector API how many data lanes to use\nwhich is dependent on the architecture.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Find the preferred species for the architecture</span>\n<span class=\"token class-name\">VectorSpecies</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Double</span><span class=\"token punctuation\">></span></span> <span class=\"token constant\">SPECIES</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">DoubleVector</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SPECIES_PREFERRED</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">double</span> min <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POSITIVE_INFINITY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">double</span> max <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEGATIVE_INFINITY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">double</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> values<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> values<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token constant\">SPECIES</span><span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token constant\">SPECIES</span><span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">DoubleVector</span> vector <span class=\"token operator\">=</span> <span class=\"token class-name\">DoubleVector</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromArray</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SPECIES</span><span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    min <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">,</span> vector<span class=\"token punctuation\">.</span><span class=\"token function\">reduceLanes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">VectorOperators</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MIN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    max <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">,</span> vector<span class=\"token punctuation\">.</span><span class=\"token function\">reduceLanes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">VectorOperators</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MAX</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sum <span class=\"token operator\">+=</span> vector<span class=\"token punctuation\">.</span><span class=\"token function\">reduceLanes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">VectorOperators</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The next problem was getting all the temperature values for a weather\nstation into a single array. Since there is no way to know how many\ntemperature values a weather station would have a dynamic list of\ntemperature values would need to be maintained. I knew this would significantly\nincrease the memory usage and introduce additional overhead to copy the data\ninto the vector but was hoping the parallel processing would more than make up\nfor the difference.</p>\n<h2>See What Sticks</h2>\n<p>In addition to SIMD, I thought this would be a great opportunity to try out\nother new Java features from recent releases that boasted performance\nimprovements. Virtual Threads? Sure, why not. Records? Couldn't hurt.</p>\n<p>Virtual threads are Java's implementation of green threads, a lightweight\nthread that is managed by the JVM instead of the operating system. This\nreduces the overhead of creating and managing threads and can improve\nperformance in I/O bound tasks by creating more blocking threads than the\noperating system would allow. Also, the changes needed to use virtual threads\nwere dead simple. Just replace <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executors.html#newFixedThreadPool-int-\"><code class=\"language-text\">Executors.newFixedThreadPool()</code></a>\nwith <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/Executors.html#newVirtualThreadPerTaskExecutor()\"><code class=\"language-text\">Executors.newVirtualThreadPerTaskExecutor()</code></a>\nand the JVM handles the rest.</p>\n<p>Records are a new feature in Java 16 that provide a compact syntax for\ndeclaring classes that are transparent holders for immutable data. In\naddition to reducing the amount of boilerplate code, records are designed to\nbe more memory efficient and faster than traditional classes. Sounds like a\nwin-win proposal to me.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">TemperatureRecord</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> station<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> temperature<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Send It</h2>\n<p>Ready to be blown away, I ran the program and.. it was about the same, this\ntime around 63 seconds. This could easily be chalked up to a few extra\nFirefox tabs open in the background meaning all of those changes likely had\nlittle effect.</p>\n<p>So what happened? Surely processing an entire array of temperature values in\nparallel would be faster even with the overhead of copying the data. After\ndigging around I found that the preferred species for the Apple's M1\narchitecture only supports 2 data lanes for double values. This meant\nthat the Vector API was only processing 2 temperature values at a time, not\nexactly the parallel processing I was hoping for.</p>\n<h1>Back To The Basics</h1>\n<p>At this point I exhausted all the ideas I set out to test and started to\nlook at how other entries were able to process the file so quickly. The\n<a href=\"https://github.com/gunnarmorling/1brc/blob/main/src/main/java/dev/morling/onebrc/CalculateAverage_royvanrijn.java\">first place entry</a>\nat the time was able to process the file in 6 seconds and also made use of a\nmemory mapped file and a ConcurrentHashMap. However, their solution also made\nheavy use of Java's <code class=\"language-text\">Unsafe</code> API that exposes many lower level operations that\nare usually reserved for internal use in the JDK. It was also on the\ndeprecation path and would be removed in future versions.</p>\n<p>However, one interesting thing I noticed was the use of Java's\n<a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--\"><code class=\"language-text\">Collection.parallelStream()</code></a>\nover the chunk ranges. I'm a huge fan of the Stream API but I initially\ndismissed it assuming it would introduce additional overhead over the\ntraditional <code class=\"language-text\">ExecutorService</code>.</p>\n<p>I also changed the way process <code class=\"language-text\">processChunk()</code> works. Instead of updating a\nshared <code class=\"language-text\">ConcurrentHashMap</code> I had created a local <code class=\"language-text\">HashMap</code> for each thread and\nmerged them at the end. I was hoping this would reduce any lock contention\nand expensive atomic operations that were needed to safely share the <code class=\"language-text\">Map</code>\nbetween threads.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">long</span> segmentSize <span class=\"token operator\">=</span> fileSize <span class=\"token operator\">/</span> processors<span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> resultString <span class=\"token operator\">=</span> <span class=\"token class-name\">IntStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> processors <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mapToObj</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> segmentSize<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> end<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        end <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> processors <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">adjustToLineEnd</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> segmentSize<span class=\"token punctuation\">,</span> fileSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> fileSize<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Submit a task to process each file segment</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeasurementAggregator</span><span class=\"token punctuation\">></span></span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">processChunk</span><span class=\"token punctuation\">(</span>fileChannel<span class=\"token punctuation\">,</span> start<span class=\"token punctuation\">,</span> end <span class=\"token operator\">-</span> start<span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> results<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>finalResults<span class=\"token punctuation\">,</span> individualResult<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">mergeHashMaps</span><span class=\"token punctuation\">(</span>finalResults<span class=\"token punctuation\">,</span> individualResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> finalResults<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallelStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>entry <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> station <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">MeasurementAggregator</span> aggregator <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">double</span> mean <span class=\"token operator\">=</span> aggregator<span class=\"token punctuation\">.</span>sum <span class=\"token operator\">/</span> aggregator<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s=%.2f/%.2f/%.2f\"</span><span class=\"token punctuation\">,</span> station<span class=\"token punctuation\">,</span> aggregator<span class=\"token punctuation\">.</span>min<span class=\"token punctuation\">,</span> mean<span class=\"token punctuation\">,</span> aggregator<span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">joining</span><span class=\"token punctuation\">(</span><span class=\"token string\">\", \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Make It So</h2>\n<p>With some hesitation, I ran the program and was surprised to see it finished\nin almost half the time at 33 seconds. Overall I was pretty happy with the\nresult. I could spend many more hours trying to learn the deprecated\n<code class=\"language-text\">Unsafe</code> API or adding significant complexity, unrolling loops, and avoiding\ncontrol structures and generic APIs for to squeeze out even more performance,\nbut I'll save that exploration for another day.</p>\n<h1>Lessons Learned</h1>\n<p>It seems abundantly obvious in retrospect but optimal performance is much\nmore a function of good design and fundamentals than it is about clever\ntricks and exotic APIs. Sure there are many tricks for getting more\nperformance out of a system, and they can be useful to know, but it is far\nmore important to understand what is happening on a lower level and avoiding\nthe common foot-guns that are so tempting to use. Oh, and just use a profiler,\nit's much easier than pulling all levers!</p>","frontmatter":{"title":"The 1 Billion Row Challenge - Part 1","date":"February 08, 2024","description":"The 1 Billion Row Challenge is a competition to read and process a billion rows from a text file in Java. This is the first part of a series of posts that will explore my approach and what I learned along the way."}},"previous":{"fields":{"slug":"/hello-gatsby/"},"frontmatter":{"title":"Hello, Gatsby"}},"next":{"fields":{"slug":"/plausible-analytics/"},"frontmatter":{"title":"Plausible Analytics"}}},"pageContext":{"id":"2871f3ca-913e-55df-b40f-36c8b90aba64","previousPostId":"0ca17847-c885-5a62-b0d3-9e728c3c2213","nextPostId":"718d45ee-875b-584e-ae17-0d533295a510"}},"staticQueryHashes":["1324386404","3274528899"],"slicesMap":{}}